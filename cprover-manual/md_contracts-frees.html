<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>CProver manual: contracts-frees</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">CProver manual
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">contracts-frees </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a href=".">CPROVER Manual TOC</a></p>
<h1><a class="anchor" id="frees-clauses"></a>
Frees Clauses</h1>
<p>A <em>frees clause</em> allows the user to specify a set of pointers that may be freed by a function or by the function it calls, transitively. A function contract may have zero or more frees clauses. When no clause is provided the empty set is used as default. Contracts can also have an empty frees clause. When more than one frees clause is given, the sets of pointers they contain are unioned together to yield a single set of pointers.</p>
<h2><a class="anchor" id="syntax"></a>
Syntax</h2>
<p>The clause has the following syntax (square brackets denote optional expressions <code>[</code> <code>]</code> ):</p>
<div class="fragment"><div class="line">__CPROVER_frees([targets])</div>
</div><!-- fragment --><p>Where <code>targets</code> has the following syntax: </p><pre class="fragment">          targets ::= cond-target-group (';' cond-target-group)* ';'?
cond-target-group ::= (condition ':')? target (',' target)*
           target ::= lvalue-expr
                    | __CPROVER_freeable(lvalue-expr)
</pre><p>A frees clause target must be either: - an lvalue expression with a pointer type, - a call to the built-in function <code>__CPROVER_freeable</code> - a call to a user-defined side effect free and deterministic function returning the type <code>void</code> (itself containing direct or indirect calls to <code>__CPROVER_freeable</code> or to functions that call <code>__CPROVER_freeable</code>);</p>
<h3><a class="anchor" id="example"></a>
Example</h3>
<div class="fragment"><div class="line">int foo(char *arr1, char *arr2, size_t size)</div>
<div class="line">__CPROVER_frees(</div>
<div class="line">    // `arr1` is freeable only if the condition `size &gt; 0 &amp;&amp; arr1` holds</div>
<div class="line">    size &gt; 0 &amp;&amp; arr1: arr1;</div>
<div class="line"> </div>
<div class="line">    // `arr2` is always freeable</div>
<div class="line">    arr2;</div>
<div class="line">)</div>
<div class="line">{</div>
<div class="line">  if(size &gt; 0 &amp;&amp; arr1)</div>
<div class="line">    free(arr1);</div>
<div class="line">  free(arr2);</div>
<div class="line">  return 0;</div>
<div class="line">}</div>
</div><!-- fragment --><h2><a class="anchor" id="semantics"></a>
Semantics</h2>
<p>The set of pointers specified by the frees clause of the contract is interpreted at the function call-site where the contract is being checked or used to abstract a function call.</p>
<h3><a class="anchor" id="for-contract-checking"></a>
For contract checking</h3>
<p>When checking a contract against a function, each pointer that the function attempts to free gets checked for membership in the set of pointers specified by the <em>frees clause</em>.</p>
<h3><a class="anchor" id="for-replacement-of-function-calls-by-contracts"></a>
For replacement of function calls by contracts</h3>
<p>When replacing a function call by a contract, each pointer of the <em>frees clause</em> is non-deterministically freed after the function call.</p>
<h2><a class="anchor" id="specifying-parametric-sets-of-freeable-pointers-using-c-functions"></a>
Specifying parametric sets of freeable pointers using C functions</h2>
<p>Users can define parametric sets of freeable pointers by writing functions that return the built-in type void and call the built-in function <code>__CPROVER_freeable</code> (directly or indirectly through some other user-defined function). The functions must be side-effect free and deterministic, as well as loop-free and recursion-free.</p>
<div class="fragment"><div class="line">void my_freeable_set(char **arr, size_t size)</div>
<div class="line">{</div>
<div class="line">  // The first 3 pointers are freeable</div>
<div class="line">  // if the array is at least of size 3.</div>
<div class="line">  if (arr &amp;&amp; size &gt; 3) {</div>
<div class="line">    __CPROVER_freeable(arr[0]);</div>
<div class="line">    __CPROVER_freeable(arr[1]);</div>
<div class="line">    __CPROVER_freeable(arr[2]);</div>
<div class="line">  }</div>
<div class="line">}</div>
</div><!-- fragment --><p>The built-in function:</p>
<div class="fragment"><div class="line">void __CPROVER_freeable(void *ptr);</div>
</div><!-- fragment --><p>adds the given pointer to the freeable set described by the enclosing function.</p>
<p>Calls to such functions can be used as targets in <code>__CPROVER_frees</code> clauses:</p>
<div class="fragment"><div class="line">void my_function(char **arr, size_t size)</div>
<div class="line">__CPROVER_frees(my_freeable_set(arr, size))</div>
<div class="line">{</div>
<div class="line">  ...</div>
<div class="line">}</div>
</div><!-- fragment --><h2><a class="anchor" id="frees-clause-related-predicates"></a>
Frees clause related predicates</h2>
<p>The predicate:</p>
<div class="fragment"><div class="line">__CPROVER_bool __CPROVER_is_freeable(void *ptr);</div>
</div><!-- fragment --><p>can only be used in pre and post conditions, in contract checking or replacement modes. It returns <code>true</code> if and only if the pointer satisfies the preconditions of the <code>free</code> function from <code>stdlib.h</code> (<a href="https://github.com/diffblue/cbmc/blob/cf00a53bbcc388748be9668f393276f6d84b1a60/src/ansi-c/library/stdlib.c#L269">see here</a>), that is if and only if the pointer points to a valid dynamically allocated object and has offset zero.</p>
<p>The predicate:</p>
<div class="fragment"><div class="line">__CPROVER_bool __CPROVER_was_freed(void *ptr);</div>
</div><!-- fragment --><p>can only be used in post conditions and returns <code>true</code> if and only if the pointer was freed during the execution of the function under analysis.</p>
<p>Last modified: 2022-10-26 23:34:07 +0100 </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.17
</small></address>
</body>
</html>
